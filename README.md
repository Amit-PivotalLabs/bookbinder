# Bookbinder

Bookbinder is a gem that binds together a unified documentation web-app from disparate source material, stored as repositories of markdown on GitHub. It runs [middleman](http://middlemanapp.com/) to produce a (CF-pushable) Sinatra app.

## About

Bookbinder is meant to be used from within a "book" project. The book project provides a configuration of which documentation repositories to pull in; the bookbinder gem provides a set of scripts to aggregate those repositories and publish them to various locations. It also provides scripts for running a CI system that can detect when a documentation repository has been updated with new content, and then verify that the composed book is free of any dead links.

## Setting Up a Book Project

A book project needs a few things to allow bookbinder to run. Here's the minimal directory structure you need in a book project:

```
.
├── Gemfile
├── Gemfile.lock
├── .gitignore
├── .ruby-version
├── config.yml
└── master_middleman
    ├── config.rb
    └── source
        └── index.html.md
```

`Gemfile` needs to point to this bookbinder gem, and probably no other gems. `Gemfile.lock` can be created by bundler automatically (see below).

`config.yml` is a YAML file that represents a hash. The following keys are used:

- **repos**: an array of hashes which specifies which documentation repositories to pull in. Each hash needs to specify
    - *github_repo*: the path on github to this repository, i.e. 'organization/repository'. The organization is ignored when finding repositories locally. The repository must be public (unless finding repositories locally).
    - *directory*: (optional) a "pretty" directory path under the main root that the webapp will use for this sub-repo.
    - *sha*: (optional) the sha of the repo to use when downloading it from github. Ignored when finding repositories locally.
- **github_username**: any github username (used for Github API calls). We recommend using a non-person "role" account for this.
- **github_password**: your github password
- **pdf**: (optional) Bookbinder can generate a PDF from one output (.html) file. To format it properly, you need to include print-specific stylesheets.
    - **page**: path of webpage to turn into a PDF (remember to use the "pretty" path if using the 'directory' key in the repo)
    - **filename**: name of the outputted PDF
- **aws_credentials**: For CI and deployment scripts. These allow bookbinder's CI scripts to push/pull green builds to/from S3
    - **access_key**: your AWS access key
    - **secret_key**: your AWS secret key
- **green_builds_bucket**: For CI and deployment scripts. This is where we store builds that go green on Jenkins, and are ready to be pushed to production.
- **cf_credentials**: For deployment scripts.
    - **username**: CF username. As with github, we advise to use a non-person "role" account here.
    - **password**: CF password.

`.gitignore` should contain the following entries, which are directories generated by bookbinder:

    output
    final_app

`master_middleman` is a directory which forms the basis of your site. [Middleman](http://middlemanapp.com/) configuration and top-level assets, javascripts, and stylesheets are all placed in here. You can also have ERB layout files. Each time a publish operation is run, this directory is copied into output/. Then each doc-repo is copied (as a directory) into the source folder, before middleman is run to generate the final app.

`.ruby-version` is used by [rbenv](https://github.com/sstephenson/rbenv) to find the right ruby. We haven't tested bookinbder with RVM so we don't know if it will work, so we recommend rbenv unless you are feeling experimental. WARNING: If you install rbenv, you MUST uninstall RVM first (http://robots.thoughtbot.com/post/47273164981/using-rbenv-to-manage-rubies-and-gems).

## Bootstrapping with Bundler

Bookbinder uses bundler and we recommend installing [rbenv](https://github.com/sstephenson/rbenv).

Once rbenv is set up and the correct ruby version is set up (2.0.0-p195), run (in your book project)

    gem install bundler
    bundle

And you should be good to go!


Bookbinder's entry point is the `bookbinder` executable. The following commands are available:

### `publish`

Bookbinder's most important command is `publish`. It takes one argument on the command line:

        bookbinder publish local

will find documentation repositories in directories that are siblings to your current directory, while

        bookbinder publish github

will find doc repos by downloading the latest version from github.

The publish command creates 2 output directories, one named `output/` and one named `final_app/`. These are placed in the current directory and are cleared each time you run bookbinder.

`final_app/` contains bookbinder's ultimate output: a Sinatra web-app that can be pushed to cloud foundry or run locally.

`output/` contains intermediary state, including the final prepared directory that the `publish` script ran middleman against, in `output/master_middleman`.
