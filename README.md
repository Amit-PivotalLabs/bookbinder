[![Code Climate](https://codeclimate.com/github/pivotal-cf/docs-bookbinder.png)](https://codeclimate.com/github/cloudfoundry-incubator/bookbinder) [![Build Status](https://travis-ci.org/cloudfoundry-incubator/bookbinder.svg?branch=master)](https://travis-ci.org/cloudfoundry-incubator/bookbinder)
# Bookbinder

Bookbinder is a gem that binds together a unified documentation web application from disparate source material. Currently, the source material must be markdown or plain HTML, and must be stored in local directories or in GitHub repositories. Bookbinder runs [middleman](http://middlemanapp.com/) to produce a Rackup app that can be deployed to Cloud Foundry.

**Note**: The Bookbinder gem is now known as `bookbindery`. Please update your Gemfiles accordingly.

## Usage

Bookbinder is meant to be used from within a project called a **book**. The book includes a configuration file that describes which documentation repositories to use as source materials. The bookbindery gem provides a set of scripts to aggregate those repositories and publish them to various locations. Bookbinder also provides scripts for running on a Continuous Integration system that can detect when a documentation repository has been updated with new content and that can verify a composed book is free of any dead links.

## Installation

**Note**: Bookbinder requires Ruby version 2.0.0-p195 or higher.

To install the Bookbinder gem, add `gem "bookbindery"` to your Gemfile. 
Creating a book is currently a little more involved, but we plan to automate this process in the near future.

### Creating a book from scratch using local sections

The disparate source material of your book is organized into separate
git repositories. When writing documentation on your local machine, however,
you'll want uncommitted changes to be added to the preview web site that you serve
on your machine.

The `bind local` command performs this operation by gathering local sections from
sibling directories of your book. These sections' directories must have the
same name as their GitHub repositories, but don't need to be git repositories.

The following is an annotated script that sets up a new book allowing 'bind
local' to run successfully. It assumes you want to call your book 'mynewbook'
and that the first and only section within the book is
[cloudfoundry/docs-dev-guide](https://github.com/cloudfoundry/docs-dev-guide).

    mkdir mynewbook
    cd mynewbook

    # Create a Gemfile.
    bundle init

    # Add the bookbindery gem to it.
    echo 'gem "bookbindery"' >> Gemfile

    # Install gems listed in the Gemfile, creating a bin/ dir for executables.
    bundle install --binstubs

    # Create a minimal configuration file.
    cat > config.yml <<YAML
    book_repo: myorg/myrepo
    public_host: localhost:9292
    sections:
    - repository:
        name: cloudfoundry/docs-dev-guide
      directory: my/included-section
    pdf:
    YAML

    # Create a directory required by Middleman.
    mkdir -p master_middleman/build

    # Clone the section in the config.yml so it can be included in the
    # final site.
    git clone https://github.com/cloudfoundry/docs-dev-guide ../docs-dev-guide

    # Run the bind local command, which pulls in the section from the directory
    # cloned above.
    bin/bookbinder bind local

    # Start up the web site locally
    cd final_app
    bundle
    rackup

You should now be able to visit
[localhost:9292/my/included-section](http://localhost:9292/my/included-section)
and see the section that was brought in. The [home page](http://localhost:9292/)
currently 404s, because we didn't put anything inside master_middleman/source/.

You can skip ahead for [more information on the bind command](#bind-command).

### Deploying your book
- Create an AWS bucket for green builds and put info into `credentials.yml`
- Set up CF spaces for staging and production and put details into `credentials.yml`
- Deploy to production
- (Optional) Register your sitemap with Google Webmaster Tools

### A more exhaustive config.yml example

```YAML
book_repo: org-name/repo-name
cred_repo: org-name/private-repo
layout_repo: org-name/master-middleman-repo		# non-optional for the generate_pdf command

sections:
  - repository:
      name: org-name/bird-repo
      ref: 165c28e967d58e6ff23a882689c953954a7b588d
    directory: birds
    subnav_template: cool-sidebar-partial		# optional
  - repository:
      name: org-name/reptile-repo
      ref: d07101dec08a698932ef0aa2fc36316d6f7c4851
    directory: reptiles
    
archive_menu:						# optional
  - v1.3.0.0
  - v1.2.0.0: archive-repo/your_pdf.yml

public_host: animals.example.com
pdf:
  header: path/to/header-file.html
template_variables:					# optional
  var_name: special-value
  other_var: 12

```

Assuming your book is in git, your `.gitignore` should contain the following
entries, which are directories generated by Bookbinder:

    output
    final_app

`master_middleman` is a directory which forms the basis of your site. [Middleman](http://middlemanapp.com/) configuration and top-level assets, javascripts, and stylesheets should all be placed in here. You can also have ERB layout files. Each time a bind operation is run, this directory is copied to `output/master_middleman`. Then each section repo is copied (as a directory) into `output/master_middleman/source/`, before middleman is run to generate the final app.

`.ruby-version` is used by [Ruby version managers](https://www.ruby-toolbox.com/categories/ruby_version_management) to select the appropriate Ruby version for a given project.

### Layout Repository

If you specify a `layout_repo:` in `config.yml` with the full name of a GitHub repository (e.g., `cloudfoundry/my-doc-layout`), it will be downloaded for use as your book's `master_middleman` directory.

### Credentials Repository

The credentials repository should be a private repository, referenced in your config.yml as `cred_repo`. It contains `credentials.yml`, which must include your deployment credentials:

```YAML
aws:
  access_key: AKIAIOSFODNN7EXAMPLE
  secret_key: wJalrXUtnFEMI/K7MDENG/bPxRfiCYzEXAMPLEKEY
  green_builds_bucket: s3_bucket_name
cloud_foundry:
  username: sam
  password: pel
  api_endpoint: https://api.run.pivotal.io
  organization: documentation-team
  app_name: docs
  staging_space: docs-staging
  production_space: docs-production
  staging_host:
    cfapps.io: 
      - staging-route-subdomain
      - another-staging-route-subdomain
  production_host:
    cfapps.io: 
      - production-route-subdomain
```

## Middleman Templating Helpers

Bookbinder comes with a Middleman configuration that provides a handful of helpful functions, and should work for most book projects. To use a custom Middleman configuration instead, place a `config.rb` file in the `master_middleman` directory of the book project. This will overwrite Bookbinder's `config.rb`.

Bookbinder provides several helper functions that can be called from within an .erb file in a doc repo, such as a layout file.

### Quick Links
`<%= quick_links %>` produces a table of contents based on in-page anchors.

### Breadcrumbs
`<%= breadcrumbs %>` generates a series of breadcrumbs as a UL HTML tag. The breadcrumbs go up to the site's top-level, based on the title of each page. The bottom-most entry in the list of breadcrumbs represents the current page; the rest of the breadcrumbs show the hiearchy of directories that the page lives in. Each breadcrumb above the current page is generated by looking at the [frontmatter](http://middlemanapp.com/basics/frontmatter/) title of the index template of that directory. If you'd like to use breadcrumb text that is different than the title, an optional 'breadcrumb' attribute can be used in the frontmatter section to override the title.

### Subnavs
`<%= yield_for_subnav %>` inserts the appropriate template in /subnavs, based on each constituent repositories' `subnav_template:` parameter in config.yml. The default template (`\_default.erb`) uses the label `default` and is applied to all sections unless another template is specified with subnav\_template. Template labels are the name of the template file with extensions removed. ("sample" for a template named "sample.erb")

### Code Snippets
`<%= yield_for_code_snippet from: 'my-org/code-repo', at: 'myCodeSnippetA' %>` inserts code snippets extracted from code repositories.

To delimit where a code snippet begins and ends, you must use the format of `code_snippet MARKER_OF_YOUR_CHOOSING start OPTIONAL_LANGUAGE`, followed by the code, and then finished with `code_snippet MARKER_OF_YOUR_CHOOSING end`:
If the `OPTIONAL_LANGUAGE` is omitted, your snippet will still be formatted as code but will not have any syntax highlighting.

Code snippet example:

```clojure

; code_snippet myCodeSnippetA start clojure
	(def fib-seq
   	  (lazy-cat [0 1] (map + (rest fib-seq) fib-seq)))
	user> (take 20 fib-seq)
	(0 1 1 2 3 5 8 13 21 34 55 89 144 233 377 610 987 1597 2584 4181)
; code_snippet myCodeSnippetA end

```

### Archive Menu

Bookbinder allows you to specify a drop-down menu template for use in the navbar. This can contain links to PDFs or other archived versions of documentation. To specify a dropdown menu, add the `archive_menu` key in config.yml as follows:

```
  archive_menu:
    - v1.3.0.0
    - v1.2.0.0: my-pdf-repo/v1.2.0.0.pdf
```

The first key (e.g. v1.3.0.0) is available for use as a title in your navbar. You can configure the structure of the drop-down menu by creating a template in `master_middleman/source/archive_menus/_default.erb`.

Finally, to insert the archive menu, use the `<%= yield_for_archive_menu %>` tag in the appropriate part of the navbar in your layout.erb. 

### Including Assets 

Bookbinder also includes helper code to correctly find image, stylesheet, and javascript assets. When using `<% image_tag ...`, `<% stylesheet_link_tag ...`, or `<% javascript_include_tag ...` to include assets, Bookbinder will search the entire directory structure starting at the top-level until it finds an asset with the provided name. For example, when resolving `<% image_tag 'great_dane.png' %>` called from the page `dogs/big_dogs/index.html.md.erb`, Middleman will first look in `images/great_dane.png.` If that file does not exist, it will try `dogs/images/great_dane.png`, then `dogs/big_dogs/images/great_dane.png`.

## Commands

Bookbinder's entry point is the `bookbinder` executable. It should be invoked from the book directory. The following commands are available:

### `bind` command

Bookbinder's most important command is `bind`. It takes one argument on the command line: `local` or `github`.

        bin/bookbinder bind local

will find documentation repositories in directories that are siblings to your current directory.

        bin/bookbinder bind github 

will find doc repos by downloading the latest version from GitHub. Note that if any of the repositories configured as 'sections' are private, you should [create a GitHub SSH key](https://help.github.com/articles/generating-ssh-keys/) for Bookbinder from an account that has access to the section repositories.

You should `ssh-add` this key to give Bookbinder access to the repositories.

The bind command creates two output directories, one named `output/` and one named `final_app/`. These are placed in the current directory and are overwritten each time you run Bookbinder.

#### The `final_app` directory

`final_app/` contains Bookbinder's ultimate output: a Rack web-app that can be pushed to Cloud Foundry or run locally.

The Rack web-app will respect redirect rules specified in `redirects.rb`, so long as they conform to the `rack/rewrite` [syntax](https://github.com/jtrupiano/rack-rewrite). For example:

```ruby
rewrite   '/wiki/John_Trupiano',  '/john'
r301      '/wiki/Yair_Flicker',   '/yair'
r302      '/wiki/Greg_Jastrab',   '/greg'
r301      %r{/wiki/(\w+)_\w+},    '/$1'
```

#### The `output` directory

`output/` contains an intermediary state. This includes `output/master_middleman`, the final prepared directory that the `bind` script ran middleman against.

**Note**: As of version 0.2.0, the `bind` command no longer generates PDFs.

### `generate_pdf` command

        bin/bookbinder generate_pdf

generates a PDF against the currently available `final_app` directory. **Note**: You must run `bind [local | github]` before running `generate_pdf`.

You can specify which pages to include in a PDF using `bin/bookbinder generate_pdf my-pdf.yml`. `my-pdf.yml` contains the configuration for the pdf. It must be formatted as YAML and **requires the keys** `header` and `pages`.

`my-pdf.yml` example:

```yml
---
copyright_notice: 'Copyright Pivotal Software Inc, 2042-2043'
header: some-header.html
pages:
    - my-book/intro.html
    - my-book/dramatic-peak.html
    - my-book/denouement.html
```

Each path provided under `pages` must match the `directory` of its `repository` in `config.yml`. The header is pulled in from the `layout_repo`, so the file `some-header.html` is expected to exist at the top level in the repo `my-username/my-layout`. The contents of `some-header.html` will be added as a header to each page within the generated pdf.

Example of `some-header.html`:

```html
<!DOCTYPE html>
<html>
  <body>
    <div class='pdf_header' style="background-color:#ffffff; padding:12px 0px 12px 10px">
        <img src='images/logo-big.png' style="height:20px">
    </div>
  </body>
</html>
```

For the above pages to publish to pdf, your `config.yml` must contain the following:

```yml
---
layout_repo: my-username/my-layout
sections:
- repository:
    name: my-username/my-book
    directory: my-book
```

In turn, `my-username/my-layout` must contain `some-header.html`; and `my-username/my-book` must contain the pages `intro.html`, `dramatic-peak.html`, and `denouement.html`.

An optional copyright notice may be provided as shown in the example.

The output PDF file will have the same name as the YAML file used to generate it. In this example, it will be `my-pdf.pdf` since its configuration was specified in `my-pdf.yml`.

### `update_local_doc_repos` command

As a convenience, Bookbinder provides a command to update all your local doc repos, performing a git pull on each one:

        bin/bookbinder update_local_doc_repos

### `tag` command

The `bookbinder tag` command commits Git tags to checkpoint a book and its constituent document repositories. This allows the tagged version of the documentation to be re-generated at a later time.

        bin/bookbinder tag book-formerly-known-as-v1.0.1

## Running the App Locally

    cd final_app
    bundle
    rackup

This will start a [rack](http://rack.github.io) server to serve your
documentation website locally at
[http://localhost:9292/](http://localhost:9292/). While making edits in
documentation repos, we recommend leaving this running in a dedicated shell
window. It can be terminated by hitting `ctrl-c`.

## Continuous Integration

### CI for books

The currently recommended tool for CI with Bookbinder is [GoCD](http://www.go.cd).

#### CI Runner
You will want a build that executes this shell command:

        bundle install --binstubs
        bin/bookbinder run_publish_ci
    
This will bind a book and push it to staging.

## <a name="deploying"></a>Deploying

Bookbinder has the ability to deploy the finished product to either staging or production. The deployment scripts use the gem's pre-packaged CloudFoundry Go CLI binary (separate versions for darwin-amd64 and linux-amd64 are included); any pre-installed version of the CLI on your system will **not** be used.

### Setting up CF Apps

Each book should have a dedicated CF space and host for its staging and production servers.
The Cloud Foundry organization and spaces must be created manually and specified as values for "organization", "staging_space" and "production_space" in `config.yml`.
Upon the first and second deploy, bookbinder will create two apps in the space to which it is deploying. The apps will be named `"app_name"-blue` and `"app_name"-green`.  These will be used for a [blue-green deployment](http://martinfowler.com/bliki/BlueGreenDeployment.html) scheme.  Upon successful deploy, the subdomain of `cfapps.io` specified by "staging_host" or "production_host" will point to the most recently deployed of these two apps.


### Deploy to Staging
Deploying to staging is not normally something a human needs to do: the book's CI script does this automatically every time a build passes.

The following command will deploy the build in your local 'final_app' directory to staging:

        bin/bookbinder push_local_to_staging

### Deploy to Production
Deploying to prod is always done manually. It can be done from any machine with the book project checked out, but does not depend on the results from a local bind (or the contents of your `final_app` directory). Instead, it pulls the latest green build from S3, untars it locally, and then pushes it up to prod:

        bin/bookbinder push_to_prod <build_number>

If the build_number argument is left out, the latest green build will be deployed to production.

## Generating a Sitemap for Google Search Indexing

The sitemap file `/sitemap.xml` is automatically regenerated when binding. When setting up a new docs website, make sure to add this sitemap's url in Google Webmaster Tools (for better reindexing?).

## Contributing to Bookbinder

### Running Tests

To run bookbinder's rspec suite, install binstubs, then run the included rake task:

Once: `bundle install --binstubs`

Then at any time: `bin/rake`
